<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù¾ÙˆØ±ØªÙÙˆÛŒ Ø¯Ø§Ø±Ø§ÛŒÛŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Vazirmatn', sans-serif !important; }
    .persian-numbers { font-feature-settings: "ss01"; direction: rtl; }
    .fade-update { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn { 0% { opacity: 0.2; transform: scale(0.97); } 100% { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body class="bg-yellow-400 text-black">
<main class="max-w-xl mx-auto p-3 space-y-2">
  <section class="bg-purple-800 rounded-xl shadow-2xl p-3 text-center">
     <button id="refresh-btn" class="text-white text-lg font-bold w-full">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø±Ø²Ø´ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù‡Ø§</button>
  </section>

  <section class="bg-white rounded-xl shadow-2xl p-3 text-center border-2 border-blue-700">
    <div class="text-lg font-bold space-y-1 persian-numbers drop-shadow-lg">
      <div id="usd-box">Ø¯Ù„Ø§Ø±: ...</div>
      <div id="usdt-box">ØªØªØ±: ...</div>
      <div id="gold18-box">Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: ...</div>
      <div id="fund-price-box">ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§: ...</div>
      <p id="gold-price" class="hidden"></p>
      <small id="gold-change" class="hidden"></small>
    </div>
  </section>

  <section id="gold-bubble" class="rounded-xl shadow-2xl p-2 text-center text-white persian-numbers">
    Ø­Ø¨Ø§Ø¨ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: <span id="goldbubble"></span>
  </section>

  <section id="profit-box" class="bg-white rounded-xl shadow-2xl p-3 text-center text-black mt-3 persian-numbers border-2 border-blue-700">
    Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†...
  </section>

  <section id="crypto-box" class="bg-white rounded-xl shadow-2xl p-3 text-center text-black persian-numbers border-2 border-blue-700">
    Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§...
  </section>

  <section class="bg-white rounded-xl shadow-2xl p-3 text-center persian-numbers border-2 border-blue-700">
    <h3 id="portfolio-title" class="text-2xl font-extrabold text-purple-800 mb-2 drop-shadow-lg">Ø·Ù„Ø§ÛŒ Ø¢Ø¨Ø´Ø¯Ù‡</h3>
    <p id="portfolio-value" class="text-xl font-extrabold persian-numbers text-black mt-3 drop-shadow-lg">Ù…Ù‚Ø¯Ø§Ø± Ø±ÛŒØ§Ù„ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ú¯Ø°Ø§Ø±ÛŒ: Û±Û´Û³Û°Û°Û°</p>
    <p id="merged-value" class="text-xl font-bold persian-numbers text-black mt-2 drop-shadow-lg"></p>
    <p id="profit-percent" class="text-xl font-bold persian-numbers mt-2 drop-shadow-lg"></p>
  </section>

  <section id="final-box" 
       class="bg-white rounded-xl shadow-2xl p-3 text-center text-black mt-3 persian-numbers border-2 border-blue-700 text-xl font-bold drop-shadow-lg">
    Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†
  </section>

  <p id="last-update" class="text-sm text-black text-center drop-shadow-lg mt-4 persian-numbers">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù†...</p>
</main>

<script>
(function AppModule() {
  const kahroba_UNITS = 223;
  const AVG_kahroba_PRICE = 111873;
  const BTC_AMOUNT = 0.0002921;
  const MY_GOLD_GRAMS = 0;
  const INVESTMENT_KAHROBA = 2500000;
  const INVESTMENT_BTC = 2811000;
  const INVESTMENT_BASE = INVESTMENT_KAHROBA + INVESTMENT_BTC;
  const START_DATE = new Date(2025, 10, 25);

  function toPersianNumber(input) {
    if (input === null || input === undefined) return '';
    if (typeof input === 'number') input = input.toLocaleString('en-US');
    const persianDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
    return input.toString().replace(/\d/g, d => persianDigits[d]);
  }

  function animateElement(id, content) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('fade-update');
    void el.offsetWidth;
    el.innerHTML = content;
    el.classList.add('fade-update');
  }

  function findkahrobaInArray(arr) {
    if (!Array.isArray(arr)) return null;
    return arr.find(item => {
      if (!item) return false;
      const fields = ['l18','fa','name','title','pc','pcc','pcp'];
      for (const f of fields) {
        if (item[f] && typeof item[f] === 'string' && item[f].includes && item[f].includes('Ú©Ù‡Ø±Ø¨Ø§')) return true;
      }
      return Object.values(item).some(v => typeof v === 'string' && v.includes && v.includes('Ú©Ù‡Ø±Ø¨Ø§'));
    }) || null;
  }

  async function fetchkahrobaFromEndpoints(urls) {
    for (const url of urls) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const json = await res.json();
        let arr = null;
        if (Array.isArray(json)) arr = json;
        else if (json && Array.isArray(json.data)) arr = json.data;
        else if (json && Array.isArray(json.symbols)) arr = json.symbols;
        else arr = Object.values(json).find(v => Array.isArray(v)) || null;
        const found = findkahrobaInArray(arr);
        if (found) return found;
      } catch (e) {}
    }
    return null;
  }

  async function fetchData() {
    animateElement('crypto-box', 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§...');
    animateElement('profit-box', 'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†...');
    animateElement('usd-box', 'Ø¯Ù„Ø§Ø±: ...');
    animateElement('usdt-box', 'ØªØªØ±: ...');

    try {
      const [cgRes, brsRes] = await Promise.all([
        fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,tether&vs_currencies=usd&include_24hr_change=true'),
        fetch('https://brsapi.ir/Api/Market/Gold_Currency.php?key=FreeTZPrEbgTZzbW2SSGXOlzjlulRFcz')
      ]);

      const cg = cgRes.ok ? await cgRes.json() : {};
      const brs = brsRes.ok ? await brsRes.json() : {};

      const bitcoin = cg.bitcoin || null;
      const tether = cg.tether || null;

      // USDT/IRT
      const usdtObj = brs.currency?.find(i => i.symbol==='USDT_IRT') || {};
      const usdtPrice = usdtObj.price || 1;

      // Ø¨ÛŒØª Ú©ÙˆÛŒÙ†
      if(bitcoin){
        const BTC_USD = bitcoin.usd || 0;
        const BTC_RIAL = Math.floor(BTC_AMOUNT * BTC_USD * usdtPrice);
        const btcProfitPercent = INVESTMENT_BTC ? ((BTC_RIAL - INVESTMENT_BTC)/INVESTMENT_BTC)*100 : 0;
        const btcColor = btcProfitPercent>0?'green':btcProfitPercent<0?'red':'black';

        animateElement('crypto-box', `
          <div class="text-2xl font-extrabold drop-shadow-lg text-purple-800">Ø¨ÛŒØª Ú©ÙˆÛŒÙ†</div>
          <div class="space-y-1 mt-5 text-lg font-bold drop-shadow-lg">
            <div style="color:${btcColor}">
              BTC: $${toPersianNumber(BTC_USD.toLocaleString())} (${toPersianNumber(Math.abs(btcProfitPercent).toFixed(2))}%)
              = ${toPersianNumber(BTC_RIAL.toLocaleString())} Ø±ÛŒØ§Ù„
            </div>
          </div>
        `);
      }

      // ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§
      const urls = [
        "https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreeTZPrEbgTZzbW2SSGXOlzjlulRFcz&type=1",
        "https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreeKyzGgWec9Po3hG9QVoMxMtCI3z5P&type=1",
        "https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreezhPfvWeEOGOPucTWsPukkDazGzTQ&type=1"
      ];
      const kahroba = await fetchkahrobaFromEndpoints(urls);

      if(kahroba && typeof kahroba.pc==='number'){
        const result = Math.floor((kahroba_UNITS * (kahroba.pc / 10)) - ((kahroba_UNITS * (kahroba.pc / 10))*0.12/100));
        const fundProfitPercent = INVESTMENT_KAHROBA ? ((result - INVESTMENT_KAHROBA)/INVESTMENT_KAHROBA)*100 : 0;
        const fundColor = fundProfitPercent>0?'green':fundProfitPercent<0?'red':'black';

        animateElement('fund-price-box', `<span style="color:${fundColor}">ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§: ${toPersianNumber(Math.floor(kahroba.pc).toLocaleString())} (${toPersianNumber(Math.abs(fundProfitPercent).toFixed(2))}%)</span>`);

        // merged-value Ùˆ final-box
        const merged = (bitcoin ? Math.floor(BTC_AMOUNT * bitcoin.usd * usdtPrice) : 0) + result;
        const profitAmount = merged - INVESTMENT_BASE;
        const profitPercent = INVESTMENT_BASE ? (profitAmount/INVESTMENT_BASE)*100 : 0;
        const profitColor = profitPercent>0?'green':profitPercent<0?'red':'black';

        animateElement('merged-value', `Ø§Ø±Ø²Ø´ Ø¯Ø§Ø±Ø§ÛŒÛŒ: ${toPersianNumber(merged)}`);
        const finalBox = document.getElementById('final-box');
        finalBox.style.color = profitColor;
        finalBox.innerText = `Ø¨Ø§Ø²Ø¯Ù‡ÛŒ: ${toPersianNumber(Math.abs(profitAmount))} (${toPersianNumber(Math.abs(profitPercent).toFixed(2))}%)`;
      }

      // Ù†Ù…Ø§ÛŒØ´ Ø¯Ù„Ø§Ø±ØŒ ØªØªØ±ØŒ Ø·Ù„Ø§ Ùˆ Ø³Ø§ÛŒØ± Ø¹Ù†Ø§ØµØ± Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„
      const usd = brs.currency?.find(i=>i.symbol==='USD') || {};
      const gold18 = brs.gold?.find(i=>i.symbol==='IR_GOLD_18K') || {};

      if(usd){
        const color = usd.change_value>0?'green':usd.change_value<0?'red':'black';
        animateElement('usd-box', `<span style="color:${color}">Ø¯Ù„Ø§Ø±: ${toPersianNumber(Math.floor(usd.price).toLocaleString())} (${toPersianNumber(Math.abs(usd.change_value).toLocaleString())} | ${toPersianNumber(Math.abs(usd.change_percent.toFixed(2)))}%)</span>`);
      }

      if(usdtObj){
        const color = usdtObj.change_percent>0?'green':usdtObj.change_percent<0?'red':'black';
        animateElement('usdt-box', `<span style="color:${color}">ØªØªØ±: ${toPersianNumber(usdtPrice.toLocaleString())} (${toPersianNumber(Math.abs(usdtObj.change_value).toLocaleString())} | ${toPersianNumber(Math.abs(usdtObj.change_percent.toFixed(2)))}%)</span>`);
      }

      if(gold18){
        const color = gold18.change_percent>0?'green':gold18.change_percent<0?'red':'black';
        animateElement('gold18-box', `<span style="color:${color}">Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: ${toPersianNumber(Math.floor(gold18.price).toLocaleString())} (${toPersianNumber(Math.abs(gold18.change_value).toLocaleString())} | ${toPersianNumber(Math.abs(gold18.change_percent.toFixed(2)))}%)</span>`);
      }

      // Ø­Ø¨Ø§Ø¨ Ø·Ù„Ø§
      const ounceGold = brs.gold?.find(i=>i.symbol==='XAUUSD');
      if(ounceGold && usd){
        const gvalue = ((ounceGold.price * usd.price) / 31.1034768) * 0.75;
        const gbubble = gold18 ? ((gold18.price - gvalue)/gvalue)*100 : 0;
        const goldbubbleElement = document.getElementById('goldbubble');
        const formattedGbubble = toPersianNumber(Math.abs(gbubble).toFixed(2)) + "Ùª" + (gbubble<0?"âˆ’":"");
        if(goldbubbleElement) goldbubbleElement.innerText = formattedGbubble;
        const goldBubbleBox = document.getElementById('gold-bubble');
        goldBubbleBox.classList.remove('bg-green-800','bg-blue-800','bg-red-800');
        if(gbubble<0) goldBubbleBox.classList.add('bg-green-800');
        else if(gbubble>=0 && gbubble<1) goldBubbleBox.classList.add('bg-blue-800');
        else goldBubbleBox.classList.add('bg-red-800');
      }

      // Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
      const now = new Date();
      document.getElementById('last-update').innerText = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${toPersianNumber(now.toLocaleDateString('fa-IR'))} - ${toPersianNumber(now.toLocaleTimeString('fa-IR').replace(/:\d+$/,''))}`;

    } catch(err){
      animateElement('crypto-box','Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§');
      animateElement('profit-box','Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
    }
  }

  document.getElementById('refresh-btn').addEventListener('click', fetchData);
  fetchData();
})();
</script>
</body>
</html>
