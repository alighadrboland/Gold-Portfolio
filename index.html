<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù¾ÙˆØ±ØªÙÙˆÛŒ Ø¯Ø§Ø±Ø§ÛŒÛŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Vazirmatn', sans-serif !important; }
    .persian-numbers { font-feature-settings: "ss01"; direction: rtl; }
    .fade-update { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn { 0% { opacity: 0.2; transform: scale(0.97); } 100% { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body class="bg-yellow-400 text-black">
  <main class="max-w-xl mx-auto p-3 space-y-2">
    <section class="bg-purple-800 rounded-xl shadow-2xl p-3 text-center">
       <button id="refresh-btn" class="text-white text-lg font-bold w-full">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø±Ø²Ø´ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù‡Ø§</button>
    </section>

    <section class="bg-white rounded-xl shadow-2xl p-3 text-center border-2 border-blue-700">
      <div class="text-lg font-bold space-y-1 persian-numbers drop-shadow-lg">
        <div id="usd-box">Ø¯Ù„Ø§Ø±: ...</div>
        <div id="usdt-box">ØªØªØ±: ...</div>
        <div id="gold18-box">Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: ...</div>
        <div id="fund-price-box">ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§: ...</div>
        <p id="gold-price" class="hidden"></p>
        <small id="gold-change" class="hidden"></small>
      </div>
    </section>

    <section id="gold-bubble" class="rounded-xl shadow-2xl p-2 text-center text-white persian-numbers">
      Ø­Ø¨Ø§Ø¨ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: <span id="goldbubble"></span>
    </section>

    <section id="profit-box" class="bg-white rounded-xl shadow-2xl p-3 text-center text-black mt-3 persian-numbers border-2 border-blue-700">
      Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†...
    </section>

    <section id="crypto-box" class="bg-white rounded-xl shadow-2xl p-3 text-center text-black persian-numbers border-2 border-blue-700">
      Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§...
    </section>

    <section class="bg-white rounded-xl shadow-2xl p-3 text-center persian-numbers border-2 border-blue-700">
      <h3 id="portfolio-title" class="text-2xl font-extrabold text-purple-800 mb-2 drop-shadow-lg">Ø·Ù„Ø§ÛŒ Ø¢Ø¨Ø´Ø¯Ù‡</h3>
      <p id="portfolio-value" class="text-xl font-extrabold persian-numbers text-black mt-3 drop-shadow-lg">Ù…Ù‚Ø¯Ø§Ø± Ø±ÛŒØ§Ù„ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ú¯Ø°Ø§Ø±ÛŒ: Û±Û´Û³Û°Û°Û°</p>
      <p id="merged-value" class="text-xl font-bold persian-numbers text-black mt-2 drop-shadow-lg"></p>
      <p id="profit-percent" class="text-xl font-bold persian-numbers mt-2 drop-shadow-lg"></p>
    </section>

    <section id="final-box" 
         class="bg-white rounded-xl shadow-2xl p-3 text-center text-black mt-3 persian-numbers border-2 border-blue-700 text-xl font-bold drop-shadow-lg">
      Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†
    </section>

    <p id="last-update" class="text-sm text-black text-center drop-shadow-lg mt-4 persian-numbers">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù†...</p>
  </main>

  <script>
  (function AppModule() {
    const kahroba_UNITS = 223;
    const AVG_kahroba_PRICE = 111873;
    const BTC_AMOUNT = 0.0002921;
    const MY_GOLD_GRAMS = 0;
    const INVESTMENT_KAHROBA = 2500000;
    const INVESTMENT_BTC = 2811000;
    const INVESTMENT_BASE = INVESTMENT_KAHROBA + INVESTMENT_BTC;
    const START_DATE = new Date(2025, 10, 25); // 25 Ù†ÙˆØ§Ù…Ø¨Ø± 2025

    function toPersianNumber(input) {
      if (input === null || input === undefined) return '';
      if (typeof input === 'number') input = input.toLocaleString('en-US');
      const persianDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
      return input.toString().replace(/\d/g, d => persianDigits[d]);
    }

    function animateElement(id, content) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('fade-update');
      void el.offsetWidth;
      el.innerHTML = content;
      el.classList.add('fade-update');
    }

    function findkahrobaInArray(arr) {
      if (!Array.isArray(arr)) return null;
      return arr.find(item => {
        if (!item) return false;
        const fields = ['l18','fa','name','title','pc','pcc','pcp'];
        for (const f of fields) {
          if (item[f] && typeof item[f] === 'string' && item[f].includes && item[f].includes('Ú©Ù‡Ø±Ø¨Ø§')) return true;
        }
        return Object.values(item).some(v => typeof v === 'string' && v.includes && v.includes('Ú©Ù‡Ø±Ø¨Ø§'));
      }) || null;
    }

    async function fetchkahrobaFromEndpoints(urls) {
      for (const url of urls) {
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          const json = await res.json();
          let arr = null;
          if (Array.isArray(json)) arr = json;
          else if (json && Array.isArray(json.data)) arr = json.data;
          else if (json && Array.isArray(json.symbols)) arr = json.symbols;
          else {
            arr = Object.values(json).find(v => Array.isArray(v)) || null;
          }
          const found = findkahrobaInArray(arr);
          if (found) return found;
        } catch (e) {}
      }
      return null;
    }

    async function fetchData() {
      animateElement('crypto-box', 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§...');
      animateElement('profit-box', 'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†...');
      animateElement('usd-box', 'Ø¯Ù„Ø§Ø±: ...');
      animateElement('usdt-box', 'ØªØªØ±: ...');

      try {
        const [cgRes, brsRes] = await Promise.all([
          fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,tether&vs_currencies=usd&include_24hr_change=true'),
          fetch('https://brsapi.ir/Api/Market/Gold_Currency.php?key=FreeTZPrEbgTZzbW2SSGXOlzjlulRFcz')
        ]);
        const cg = cgRes.ok ? await cgRes.json() : {};
        const brs = brsRes.ok ? await brsRes.json() : {};

        const bitcoin = cg && cg.bitcoin ? cg.bitcoin : null;
        const tether = cg && cg.tether ? cg.tether : null;
        const totalUsdFromBtc = (bitcoin && BTC_AMOUNT) ? (BTC_AMOUNT * (bitcoin.usd || 0)) : 0;

        const usdtObj = (brs && brs.currency) ? brs.currency.find(i => i.symbol === 'USDT_IRT') || {} : {};
        const usdtPrice = usdtObj.price || 0;
        const totalIrt = Math.floor(totalUsdFromBtc * usdtPrice);
        const btcpr = Math.floor(totalUsdFromBtc * usdtPrice) || 0;

        if (bitcoin) {
          const btcChange = bitcoin.usd_24h_change || 0;
          const btcm = BTC_AMOUNT * (bitcoin.usd || 0);
          const getColor = c => c > 0 ? 'green' : c < 0 ? 'red' : 'black';
          animateElement('crypto-box', `
            <div class="text-2xl font-extrabold drop-shadow-lg text-purple-800">Ø¨ÛŒØª Ú©ÙˆÛŒÙ†</div>
            <div class="space-y-1 mt-5 text-lg font-bold drop-shadow-lg">
              <div style="color:${getColor(btcChange)}">
                BTC: $${toPersianNumber((bitcoin.usd||0).toLocaleString())}
                (%${toPersianNumber(Math.abs((btcChange||0).toFixed(2)))})
                = $${toPersianNumber(Math.floor(btcm).toLocaleString())} | ${toPersianNumber(btcpr.toLocaleString())}
              </div>
            </div>
          `);
        }

        const goldList = brs && brs.gold ? brs.gold : [];
        const currencyList = brs && brs.currency ? brs.currency : [];
        const gold18 = goldList.find(i => i.symbol === 'IR_GOLD_18K') || null;
        const usd = currencyList.find(i => i.symbol === 'USD') || null;

        const today = new Date();
        const diffDays = Math.floor((today - START_DATE) / (1000 * 60 * 60 * 24));
        document.getElementById('portfolio-title').innerText = `Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø·ÛŒ ${toPersianNumber(diffDays)} Ø±ÙˆØ²`;
        animateElement('portfolio-value', `Ø§Ø±Ø²Ø´ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ú¯Ø°Ø§Ø±ÛŒ: ${toPersianNumber(INVESTMENT_BASE)}`);

        const urls = [
          "https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreeTZPrEbgTZzbW2SSGXOlzjlulRFcz&type=1",
          "https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreeKyzGgWec9Po3hG9QVoMxMtCI3z5P&type=1",
          "https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreezhPfvWeEOGOPucTWsPukkDazGzTQ&type=1"
        ];
        const kahroba = await fetchkahrobaFromEndpoints(urls);

        if (kahroba && typeof kahroba.pc === 'number') {
            const kahrobapc = kahroba.pc;
            const result = Math.floor((kahroba_UNITS * (kahrobapc / 10)) - ((kahroba_UNITS * (kahrobapc / 10) * 0.12)/100));

            const color = (kahroba.pcp !== undefined) ? (kahroba.pcp > 0 ? 'green' : kahroba.pcp < 0 ? 'red' : 'black') : 'black';
            const pcc = kahroba.pcc !== undefined ? kahroba.pcc : 0;
            const pcp = kahroba.pcp !== undefined ? kahroba.pcp : 0;

            animateElement('fund-price-box', `<span style="color:${color}">ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§: ${toPersianNumber(Math.floor(kahrobapc).toLocaleString())} (${toPersianNumber(Math.abs(pcc).toLocaleString())} | ${toPersianNumber(Math.abs(pcp.toFixed(2)))}%)</span>`);

            // Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§
            const kahrobaProfitPercent = ((result - INVESTMENT_KAHROBA) / INVESTMENT_KAHROBA) * 100;
            const kahrobaProfitColor = kahrobaProfitPercent > 0 ? 'green' : kahrobaProfitPercent < 0 ? 'red' : 'black';
            animateElement('profit-box', `
              <div class="text-2xl font-extrabold drop-shadow-lg text-purple-800">ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§ (${toPersianNumber(kahroba_UNITS.toLocaleString())} ÙˆØ§Ø­Ø¯)</div>
              <div class="text-2xl font-extrabold drop-shadow-lg text-black mt-2">${toPersianNumber(result)}</div>
              <div class="text-xl font-bold drop-shadow-lg" style="color:${kahrobaProfitColor}">(${toPersianNumber(kahrobaProfitPercent.toFixed(2))}%)</div>
            `);

            // Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø¨ÛŒØª Ú©ÙˆÛŒÙ†
            const btcValue = Math.floor(btcpr) || 0;
            const btcProfitPercent = ((btcValue - INVESTMENT_BTC) / INVESTMENT_BTC) * 100;
            const btcProfitColor = btcProfitPercent > 0 ? 'green' : btcProfitPercent < 0 ? 'red' : 'black';
            const btcBox = document.getElementById('crypto-box');
            if (btcBox) {
              btcBox.innerHTML += `
                <div class="text-xl font-bold drop-shadow-lg" style="color:${btcProfitColor}">Ø¨Ø§Ø²Ø¯Ù‡ÛŒ Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†: (${toPersianNumber(btcProfitPercent.toFixed(2))}%)</div>
              `;
            }

            // merged, profit percent Ù†Ù‡Ø§ÛŒÛŒ
            const merged = btcValue + result;
            const mergedEl = document.getElementById('merged-value');
            if (mergedEl) mergedEl.innerText = `Ø§Ø±Ø²Ø´ Ø¯Ø§Ø±Ø§ÛŒÛŒ: ${toPersianNumber(merged)}`;

            const profitAmount = merged - INVESTMENT_BASE;
            const profitPercent = INVESTMENT_BASE ? ((profitAmount) / INVESTMENT_BASE) * 100 : 0;
            const profitEl = document.getElementById('final-box');
            const profitColor = profitPercent > 0 ? 'green' : profitPercent < 0 ? 'red' : 'black';
            if (profitEl) {
               profitEl.style.color = profitColor;
               profitEl.innerText = `Ø¨Ø§Ø²Ø¯Ù‡ÛŒ: ${toPersianNumber(Math.abs(profitAmount))} (${toPersianNumber(Math.abs(profitPercent).toFixed(2))}%)`;
            }
        } else {
            animateElement('fund-price-box', 'ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯');
            animateElement('final-box', 'ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù‡Ø±Ø¨Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯');
        }

        const now = new Date();
        const formattedDate = toPersianNumber(now.toLocaleDateString('fa-IR'));
        const formattedTime = toPersianNumber(now.toLocaleTimeString('fa-IR').replace(/:\d+$/, ''));
        document.getElementById('last-update').innerText = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${formattedDate} - ${formattedTime}`;

      } catch (err) {
        animateElement('crypto-box', 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§');
        animateElement('profit-box', 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
      }
    }

    document.getElementById('refresh-btn').addEventListener('click', fetchData);
    fetchData();

    window.appFetchData = fetchData;
  })();
  </script>
</body>
</html>
